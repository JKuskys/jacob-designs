name: Build and Deploy components
on:
  push:
    branches:
      - master
permissions:
  contents: write

concurrency: ci-${{ github.ref }}

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    container: node:14-alpine

    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run build
      - run: npm run build-storybook

  test-e2e:
    name: Test e2e
    needs: build
    runs-on: ubuntu-latest
    container: node:14-alpine

    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run test-e2e

  test-components:
    name: Test components
    needs: build
    runs-on: ubuntu-latest
    container: node:14-alpine

    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run test-jest

  increase-version:
    name: Bump package version
    needs: [build, test-components]   
    runs-on: ubuntu-latest
    container: node:14-alpine

    steps:
      - uses: actions/checkout@v3
      - run: git config user.email "$GITHUB_ACTOR@users.noreply.github.com"
      - run: git config user.name "$GITHUB_ACTOR"
      - run: npm version minor -m "v%s"
      - run: VERSION=$(node -p "require('./package.json').version")
      - run: git tag ${VERSION}
      - run: git push "https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git" --follow-tags

  publish-storybook:
    name: Deploy storybook
    needs: [build, test-components, increase-version]  
    runs-on: ubuntu-latest
    container: node:14-alpine

    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Install and Build 🔧 # This example project is built using npm and outputs the result to the 'build' folder. Replace with the commands required to build your project, or remove this step entirely if your site is pre-built.
        run: |
          npm install
          npm run build
          npm run build-storybook

      - name: Deploy 🚀
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: storybook-static # The folder the action should deploy.


  publish-package:
    name: Deploy npm package
    needs: [build, test-components, increase-version]  
    runs-on: ubuntu-latest
    container: node:14-alpine

    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
      - run: npm install
      - run: npm run build
      - uses: JS-DevTools/npm-publish@v1
        with:
          token: ${{ secrets.NPM_TOKEN }}